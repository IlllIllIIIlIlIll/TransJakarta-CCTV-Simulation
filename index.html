<!-- index.html  (CrowdEase fixed mobile model load) -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CrowdEase â€” Live Person Counter</title>
<style>
/* ... keep your same CSS ... */
body{margin:0;background:#0b0b0c;color:#eee;font-family:system-ui,sans-serif}
.video-wrap{position:relative;width:100%;aspect-ratio:16/9;background:#000;overflow:hidden}
video,canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.counter{position:absolute;left:12px;top:12px;background:rgba(0,0,0,.45);
  border-radius:10px;padding:8px 12px;font-weight:700}
</style>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js"></script>
</head>
<body>
<h2 style="text-align:center;">ðŸ‘€ CrowdEase â€” Live Person Counter</h2>
<div style="text-align:center;margin:8px">
<button id="start">Start</button>
<button id="stop" disabled>Stop</button>
<select id="facing"><option value="environment">Back</option><option value="user">Front</option></select>
</div>
<div class="video-wrap">
  <video id="video" playsinline muted></video>
  <canvas id="canvas"></canvas>
  <div class="counter" id="counter">People: 0</div>
</div>
<pre id="log" style="max-height:200px;overflow:auto;font-size:12px;background:#111;padding:8px;border-radius:6px"></pre>

<script>
const logBox=document.getElementById('log');
const log=(...a)=>{console.log(...a);logBox.textContent+=a.join(' ')+'\n';logBox.scrollTop=logBox.scrollHeight;}
let model=null,stream=null,looping=false;
async function initBackend(){
  const backends=["webgl","wasm","cpu"];
  for(const b of backends){
    try{
      await tf.setBackend(b);await tf.ready();
      log("[OK] backend:",b);
      return b;
    }catch(e){log("[WARN] backend",b,"failed:",e.message);}
  }
  throw new Error("No backend available");
}
async function loadModel(){
  if(model)return model;
  const backend=await initBackend();
  log("[INFO] loading COCO-SSD on",backend);
  model=await cocoSsd.load({base:'lite_mobilenet_v2'});
  log("[OK] model loaded!");
  return model;
}
async function startCam(){
  const facing=document.getElementById('facing').value;
  stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:facing,width:{ideal:1280},height:{ideal:720}},audio:false});
  const v=document.getElementById('video');
  v.srcObject=stream;await v.play();
  log("[INFO] camera started",v.videoWidth,"x",v.videoHeight);
}
function stopCam(){if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}}
async function loop(){
  if(!looping)return;
  const v=document.getElementById('video'),c=document.getElementById('canvas');
  const ctx=c.getContext('2d');c.width=v.videoWidth;c.height=v.videoHeight;
  const preds=await model.detect(v);
  let cnt=0;
  for(const p of preds){if(p.class==="person"&&p.score>0.4)cnt++;
    if(p.class==="person"&&p.score>0.4){const[x,y,w,h]=p.bbox;ctx.strokeStyle="#0f0";ctx.lineWidth=2;ctx.strokeRect(x,y,w,h);}
  }
  document.getElementById('counter').textContent="People: "+cnt;
  requestAnimationFrame(loop);
}
document.getElementById('start').onclick=async()=>{
  try{
    document.getElementById('start').disabled=true;
    document.getElementById('stop').disabled=false;
    await startCam();
    await loadModel();
    looping=true;loop();
  }catch(e){log("[ERROR]",e);}
};
document.getElementById('stop').onclick=()=>{looping=false;stopCam();document.getElementById('start').disabled=false;document.getElementById('stop').disabled=true;log("[INFO] stopped");};
</script>
</body>
</html>
